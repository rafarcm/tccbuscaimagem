package br.com.tcc.buscaimagem.action;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

import javax.media.jai.JAI;
import javax.media.jai.PlanarImage;

import br.com.tcc.buscaimagem.form.PesquisaForm;
import br.com.tccbuscaimagem.common.Caracteristica;
import br.com.tccbuscaimagem.common.Imagem;
import br.com.tccbuscaimagem.common.ImagemCaracteristica;
import br.com.tccbuscaimagem.common.ImagemUtil;
import br.com.tccbuscaimagem.extratores.ExtratorCor;
import br.com.tccbuscaimagem.extratores.ExtratorForma;
import br.com.tccbuscaimagem.extratores.ExtratorTextura;
import br.com.tccbuscaimagem.facade.ImagemFacade;
import br.com.tccbuscaimagem.service.ImagemProvider;
import br.com.tccbuscaimagem.util.Constantes;

import com.opensymphony.xwork2.ActionSupport;

public class BuscarImagemAction extends ActionSupport {
	
	private static final long serialVersionUID = 1L;

	private PesquisaForm urlsForm;
	
	private PesquisaForm resultados;

	public String execute() throws Exception {
		
		final ImagemFacade facade = new ImagemProvider();
		resultados = new PesquisaForm();
		
		for (int i = 0; urlsForm.getUrls() != null && i < urlsForm.getUrls().length; i++) {

			final String url = urlsForm.getUrls()[i];
			final String minUrl = urlsForm.getMinUrls()[i];

			facade.processarImagem(url, minUrl);
		}
		
		final String arquivo = urlsForm.getImagemPesquisa().substring(
			(urlsForm.getImagemPesquisa().lastIndexOf("/") + 1), urlsForm.getImagemPesquisa().length());
		
		ImagemUtil.downloadImagem(urlsForm.getImagemPesquisa(), arquivo);
		final List<Imagem> imagensSimilares = facade.buscarImagensSimilares(arquivo, 5);
		
		if(imagensSimilares != null && !imagensSimilares.isEmpty()){
			
			resultados.setImagensSimilares(new ArrayList<String>());
			
			for (Imagem imagem : imagensSimilares) {
				resultados.getImagensSimilares().add(imagem.getMinUrl());
			}
		}
		ImagemUtil.deletarImagem(arquivo);
		resultados.setImagemPesquisa(urlsForm.getImagemPesquisa());
		
		return SUCCESS;
	}

	public PesquisaForm getUrlsForm() {
		return urlsForm;
	}

	public void setUrlsForm(PesquisaForm urlsForm) {
		this.urlsForm = urlsForm;
	}

	public PesquisaForm getResultados() {
		return resultados;
	}

	public void setResultados(PesquisaForm resultados) {
		this.resultados = resultados;
	}
	
	

}
